# 批次通知系統使用指南

## 📋 概述

為了避免大量警示觸發時造成郵件轟炸，系統已實作**批次通知功能**。系統會將一段時間內的多個警示整合成一封摘要郵件發送，大幅減少郵件數量。

---

## ✨ 主要功能

### 1. 批次整合
- 系統會收集一段時間內的所有警示
- 將多個警示整合成**一封**摘要郵件
- 同時支援 Email 和 LINE 通知

### 2. 用戶自定義頻率
用戶可以自行選擇通知頻率：

| 選項 | 說明 | 適用場景 |
|------|------|----------|
| **即時通知** | 每個警示立即發送 | 監控少量股票，需要即時反應 |
| **5分鐘批次** ⭐ | 每 5 分鐘整合一次發送 | **推薦設定**，平衡即時性與便利性 |
| **15分鐘批次** | 每 15 分鐘整合一次發送 | 監控多支股票，不需極即時 |
| **1小時批次** | 每小時整合一次發送 | 長期監控，關注趨勢 |
| **每日摘要** | 每天發送一次所有警示 | 非即時需求，只需每日回顧 |

---

## 🚀 使用方式

### 步驟 1：進入通知設定
1. 登入 QuantGem 系統
2. 前往「警示設定」頁面
3. 點擊頂部的「設定」按鈕

### 步驟 2：設定通知頻率
1. 在「Email 通知」區塊中：
   - 輸入接收通知的 Email 地址
   - 選擇「通知頻率」（預設為 5 分鐘批次）
   - 勾選「啟用 Email 通知」
2. 點擊「儲存設定」

### 步驟 3：建立警示規則
1. 在「新增警示規則」卡片中設定條件
2. 點擊「新增規則」
3. 系統會根據你的頻率設定自動整合通知

---

## 📧 郵件範例

### 批次通知郵件格式

當多個警示觸發時，你會收到如下格式的郵件：

**主旨：** 🔔 QuantGem 警示通知 (5 筆)

**內容：**
```
📊 QuantGem 警示摘要

您有 5 筆警示觸發：

▲ 2330 - 台積電
類型：價格突破
條件：2330 價格突破 ≥ 1300
當前值：NT$ 1320.00
觸發時間：2025/10/04 19:45:23

▼ 2317 - 鴻海
類型：價格突破
條件：2317 價格突破 ≤ 220
當前值：NT$ 218.00
觸發時間：2025/10/04 19:46:15

... (其他警示)
```

---

## 🔍 運作原理

### 批次模式（推薦）
```
警示 1 觸發 (19:41:00) ─┐
警示 2 觸發 (19:42:30) ─┤
警示 3 觸發 (19:43:45) ─┼─→ 等待至 5 分鐘 ─→ 整合發送 1 封郵件 (19:46:00)
警示 4 觸發 (19:44:10) ─┤
警示 5 觸發 (19:45:20) ─┘
```

### 即時模式
```
警示 1 觸發 → 立即發送郵件 1
警示 2 觸發 → 立即發送郵件 2
警示 3 觸發 → 立即發送郵件 3
... (可能收到大量郵件)
```

---

## ⚙️ 技術細節

### 後端實作
- 使用 `Map` 結構儲存待發送的警示
- 每個用戶有獨立的批次佇列
- 使用 `setTimeout` 控制發送時機
- 支援動態調整頻率

### 資料庫欄位
```sql
-- users 表新增欄位
notification_frequency VARCHAR(20) DEFAULT 'batch_5min'

-- 可選值
'immediate'     -- 即時
'batch_5min'    -- 5分鐘批次
'batch_15min'   -- 15分鐘批次
'batch_1hour'   -- 1小時批次
'daily'         -- 每日摘要
```

### API 端點
```javascript
POST /api/notifications/send-alert
// Request
{
  "alertData": {
    "title": "價格突破",
    "symbol": "2330",
    "name": "台積電",
    "type": "價格突破",
    "condition": "2330 價格突破 ≥ 1300",
    "message": "NT$ 1320.00",
    "direction": "▲"
  }
}

// Response (批次模式)
{
  "success": true,
  "message": "警示已加入批次佇列",
  "data": {
    "batched": true,
    "pendingCount": 3,
    "frequency": "batch_5min"
  }
}
```

---

## 💡 最佳實踐建議

### 1. 根據監控數量選擇頻率
- **1-5 支股票**：使用「即時通知」或「5 分鐘批次」
- **5-20 支股票**：使用「5 分鐘批次」或「15 分鐘批次」
- **20+ 支股票**：使用「15 分鐘批次」或「1 小時批次」
- **長期追蹤**：使用「每日摘要」

### 2. 搭配瀏覽器通知
- 啟用「瀏覽器推送通知」獲得即時提醒
- Email 批次通知作為詳細記錄

### 3. 調整警示條件
- 避免設定過於寬鬆的條件
- 使用合理的閾值減少誤報

---

## 🐛 故障排除

### 問題：未收到批次郵件

**檢查項目：**
1. ✅ 確認「啟用 Email 通知」已勾選
2. ✅ 檢查 Email 地址是否正確
3. ✅ 等待設定的批次時間（例如 5 分鐘）
4. ✅ 查看後端 console 是否有錯誤

**解決方法：**
- 嘗試切換到「即時通知」測試
- 點擊「發送測試郵件」確認 SMTP 正常

### 問題：收到太多郵件

**解決方法：**
1. 調整通知頻率為更長的間隔（例如從 5 分鐘改為 15 分鐘）
2. 檢查警示規則是否過於寬鬆
3. 考慮使用「每日摘要」模式

---

## 📊 優勢對比

### 批次通知 vs 即時通知

| 特性 | 批次通知 ⭐ | 即時通知 |
|------|-----------|---------|
| 郵件數量 | 少（整合發送） | 多（每個警示一封） |
| 即時性 | 略有延遲（可設定） | 完全即時 |
| 閱讀體驗 | 清晰整齊 | 可能雜亂 |
| 適用場景 | 多股票監控 | 少量關鍵股票 |
| 建議使用 | ✅ 推薦 | 特定需求 |

---

## 🔧 進階設定

### 自訂批次間隔（開發者）

如需新增其他時間間隔，修改後端：

```javascript
// server/routes/notifications.js
const BATCH_INTERVALS = {
  'immediate': 0,
  'batch_5min': 5 * 60 * 1000,
  'batch_15min': 15 * 60 * 1000,
  'batch_30min': 30 * 60 * 1000,  // 新增 30 分鐘
  'batch_1hour': 60 * 60 * 1000,
  'daily': 24 * 60 * 60 * 1000
};
```

並在前端新增選項：

```javascript
// src/components/NotificationSettings.vue
const frequencyOptions = [
  // ... 其他選項
  { value: 'batch_30min', label: '30分鐘批次', desc: '每 30 分鐘整合成一封郵件發送' },
];
```

---

## 📝 更新日誌

### v1.0 (2025-10-04)
- ✅ 實作批次通知系統
- ✅ 新增用戶自定義通知頻率
- ✅ 支援 Email 和 LINE 批次發送
- ✅ 優化郵件格式與內容
- ✅ 新增資料庫遷移腳本

---

## 📞 技術支援

如有問題，請提供：
1. 選擇的通知頻率
2. 後端 console 錯誤訊息
3. 警示規則設定
4. 觸發的股票數量

---

**最後更新：** 2025-10-04  
**版本：** 1.0
